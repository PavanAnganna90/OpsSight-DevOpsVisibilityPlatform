# OpsSight DevOps Platform - Staging Deployment Workflow
# Automated staging environment deployment following cursor development standards

name: ðŸš€ Deploy to Staging

on:
  workflow_run:
    workflows: ["ðŸ³ Build and Push"]
    types: [completed]
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy'
        required: false
        default: 'latest'
      skip_migrations:
        description: 'Skip database migrations'
        required: false
        default: 'false'
        type: boolean

env:
  # Reason: Staging environment configuration
  ENVIRONMENT: staging
  CLUSTER_NAME: opsight-staging-cluster
  REGISTRY: ${{ secrets.ECR_REGISTRY || '123456789012.dkr.ecr.us-west-2.amazonaws.com' }}
  FRONTEND_IMAGE: opsight/frontend
  BACKEND_IMAGE: opsight/backend

jobs:
  # Pre-deployment validation
  pre-deployment:
    name: ðŸ” Pre-deployment Checks
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    outputs:
      deploy-frontend: ${{ steps.changes.outputs.frontend }}
      deploy-backend: ${{ steps.changes.outputs.backend }}
      image-tag: ${{ steps.vars.outputs.image-tag }}
      
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ðŸ·ï¸ Set deployment variables
        id: vars
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            IMAGE_TAG="${{ github.event.inputs.image_tag }}"
          else
            IMAGE_TAG="${{ github.sha }}"
          fi
          echo "image-tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Deploying image tag: ${IMAGE_TAG}"

      - name: ðŸ“‹ Detect changes
        id: changes
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Reason: Manual deployment deploys both components
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "backend=true" >> $GITHUB_OUTPUT
          else
            # Reason: Check which components changed in the last commit
            FRONTEND_CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -E '^frontend/' | wc -l)
            BACKEND_CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -E '^backend/' | wc -l)
            
            echo "frontend=$([[ $FRONTEND_CHANGED -gt 0 ]] && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "backend=$([[ $BACKEND_CHANGED -gt 0 ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          role-session-name: github-actions-staging-deploy
          aws-region: ${{ secrets.AWS_REGION || 'us-west-2' }}

      - name: âœ… Verify images exist
        run: |
          aws ecr describe-images \
            --repository-name opsight/frontend \
            --image-ids imageTag=${{ steps.vars.outputs.image-tag }} \
            --region ${{ secrets.AWS_REGION || 'us-west-2' }} || {
            echo "âŒ Frontend image not found"
            exit 1
          }
          
          aws ecr describe-images \
            --repository-name opsight/backend \
            --image-ids imageTag=${{ steps.vars.outputs.image-tag }} \
            --region ${{ secrets.AWS_REGION || 'us-west-2' }} || {
            echo "âŒ Backend image not found"
            exit 1
          }
          
          echo "âœ… All images verified"

  # Database migrations
  database-migration:
    name: ðŸ—„ï¸ Database Migration
    runs-on: ubuntu-latest
    needs: pre-deployment
    if: needs.pre-deployment.outputs.deploy-backend == 'true' && github.event.inputs.skip_migrations != 'true'
    
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          role-session-name: github-actions-db-migration
          aws-region: ${{ secrets.AWS_REGION || 'us-west-2' }}

      - name: âš™ï¸ Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: ðŸ”— Configure kubectl
        run: |
          aws eks update-kubeconfig \
            --name ${{ env.CLUSTER_NAME }} \
            --region ${{ secrets.AWS_REGION || 'us-west-2' }}

      - name: ðŸ—„ï¸ Run database migrations
        run: |
          kubectl create job migration-${{ github.run_number }} \
            --from=cronjob/db-migration \
            --namespace=staging || true
          
          # Reason: Wait for migration job to complete
          kubectl wait --for=condition=complete \
            --timeout=300s \
            job/migration-${{ github.run_number }} \
            --namespace=staging
          
          # Reason: Check migration job status
          if ! kubectl get job migration-${{ github.run_number }} -o jsonpath='{.status.succeeded}' --namespace=staging | grep -q 1; then
            echo "âŒ Database migration failed"
            kubectl logs job/migration-${{ github.run_number }} --namespace=staging
            exit 1
          fi
          
          echo "âœ… Database migration completed"

  # Frontend deployment
  deploy-frontend:
    name: ðŸŽ¨ Deploy Frontend
    runs-on: ubuntu-latest
    needs: [pre-deployment, database-migration]
    if: always() && needs.pre-deployment.outputs.deploy-frontend == 'true' && (needs.database-migration.result == 'success' || needs.database-migration.result == 'skipped')
    
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          role-session-name: github-actions-frontend-deploy
          aws-region: ${{ secrets.AWS_REGION || 'us-west-2' }}

      - name: âš™ï¸ Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: ðŸ”— Configure kubectl
        run: |
          aws eks update-kubeconfig \
            --name ${{ env.CLUSTER_NAME }} \
            --region ${{ secrets.AWS_REGION || 'us-west-2' }}

      - name: ðŸš€ Deploy Frontend
        run: |
          # Reason: Update deployment with new image
          kubectl set image deployment/frontend-deployment \
            frontend=${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:${{ needs.pre-deployment.outputs.image-tag }} \
            --namespace=staging
          
          # Reason: Add deployment annotations for tracking
          kubectl annotate deployment/frontend-deployment \
            deployment.kubernetes.io/revision- \
            --namespace=staging
          
          kubectl annotate deployment/frontend-deployment \
            "github.com/sha=${{ github.sha }}" \
            "github.com/run-id=${{ github.run_id }}" \
            "github.com/workflow=${{ github.workflow }}" \
            --namespace=staging --overwrite

      - name: â³ Wait for rollout
        run: |
          kubectl rollout status deployment/frontend-deployment \
            --namespace=staging \
            --timeout=300s

      - name: ðŸ§ª Run smoke tests
        run: |
          # Reason: Get service endpoint for testing
          FRONTEND_URL=$(kubectl get service frontend-service \
            --namespace=staging \
            -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          
          if [[ -n "$FRONTEND_URL" ]]; then
            # Reason: Wait for load balancer to be ready
            sleep 30
            
            # Reason: Simple health check
            curl -f "http://${FRONTEND_URL}/health" || {
              echo "âŒ Frontend health check failed"
              exit 1
            }
            echo "âœ… Frontend smoke test passed"
          else
            echo "âš ï¸ Frontend service endpoint not available for testing"
          fi

  # Backend deployment
  deploy-backend:
    name: ðŸ Deploy Backend
    runs-on: ubuntu-latest
    needs: [pre-deployment, database-migration]
    if: always() && needs.pre-deployment.outputs.deploy-backend == 'true' && (needs.database-migration.result == 'success' || needs.database-migration.result == 'skipped')
    
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          role-session-name: github-actions-backend-deploy
          aws-region: ${{ secrets.AWS_REGION || 'us-west-2' }}

      - name: âš™ï¸ Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: ðŸ”— Configure kubectl
        run: |
          aws eks update-kubeconfig \
            --name ${{ env.CLUSTER_NAME }} \
            --region ${{ secrets.AWS_REGION || 'us-west-2' }}

      - name: ðŸš€ Deploy Backend
        run: |
          # Reason: Update deployment with new image
          kubectl set image deployment/backend-deployment \
            backend=${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ needs.pre-deployment.outputs.image-tag }} \
            --namespace=staging
          
          # Reason: Add deployment annotations for tracking
          kubectl annotate deployment/backend-deployment \
            deployment.kubernetes.io/revision- \
            --namespace=staging
          
          kubectl annotate deployment/backend-deployment \
            "github.com/sha=${{ github.sha }}" \
            "github.com/run-id=${{ github.run_id }}" \
            "github.com/workflow=${{ github.workflow }}" \
            --namespace=staging --overwrite

      - name: â³ Wait for rollout
        run: |
          kubectl rollout status deployment/backend-deployment \
            --namespace=staging \
            --timeout=300s

      - name: ðŸ§ª Run API health checks
        run: |
          # Reason: Get service endpoint for testing
          BACKEND_URL=$(kubectl get service backend-service \
            --namespace=staging \
            -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          
          if [[ -n "$BACKEND_URL" ]]; then
            # Reason: Wait for load balancer to be ready
            sleep 30
            
            # Reason: API health check
            curl -f "http://${BACKEND_URL}/health" || {
              echo "âŒ Backend health check failed"
              exit 1
            }
            
            # Reason: API readiness check
            curl -f "http://${BACKEND_URL}/ready" || {
              echo "âŒ Backend readiness check failed"
              exit 1
            }
            
            echo "âœ… Backend health checks passed"
          else
            echo "âš ï¸ Backend service endpoint not available for testing"
          fi

  # Post-deployment verification
  post-deployment:
    name: âœ… Post-deployment Verification
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    if: always()
    
    steps:
      - name: ðŸ“Š Generate deployment report
        run: |
          echo "## ðŸš€ Staging Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Staging" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ needs.pre-deployment.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ needs.deploy-frontend.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: ${{ needs.deploy-backend.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.deploy-frontend.result }}" == "success" && "${{ needs.deploy-backend.result }}" == "success" ]]; then
            echo "ðŸŽ‰ **Staging deployment completed successfully!**" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "âŒ **Staging deployment encountered issues.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi 