---
# External Secrets Operator - SecretStore for AWS Secrets Manager
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secrets-manager
  namespace: opssight-production
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secret-store
    environment: production
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-west-2
      auth:
        secretRef:
          accessKeyID:
            name: aws-secret
            key: access-key-id
          secretAccessKey:
            name: aws-secret
            key: secret-access-key
        jwt:
          serviceAccountRef:
            name: external-secrets-sa

---
# ServiceAccount for External Secrets Operator
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-secrets-sa
  namespace: opssight-production
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/opssight-external-secrets-role
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: service-account

---
# AWS IAM credentials secret (will be managed externally)
apiVersion: v1
kind: Secret
metadata:
  name: aws-secret
  namespace: opssight-production
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: aws-credentials
type: Opaque
stringData:
  # These should be set via CI/CD pipeline or external management
  access-key-id: ""
  secret-access-key: ""

---
# External Secret for OpsSight Database Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: opssight-database-secrets
  namespace: opssight-production
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: database-secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: opssight-database-secrets
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: opssight
          app.kubernetes.io/component: database-secrets
          environment: production
      data:
        DB_PASSWORD: "{{ .db_password | toString }}"
        DB_URL: "postgresql://{{ .db_username | toString }}:{{ .db_password | toString }}@{{ .db_host | toString }}:5432/{{ .db_name | toString }}"
  data:
  - secretKey: db_username
    remoteRef:
      key: opssight/production/database
      property: username
  - secretKey: db_password
    remoteRef:
      key: opssight/production/database
      property: password
  - secretKey: db_host
    remoteRef:
      key: opssight/production/database
      property: host
  - secretKey: db_name
    remoteRef:
      key: opssight/production/database
      property: database

---
# External Secret for OpsSight Application Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: opssight-app-secrets
  namespace: opssight-production
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: app-secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: opssight-app-secrets
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: opssight
          app.kubernetes.io/component: app-secrets
          environment: production
      data:
        SECRET_KEY: "{{ .secret_key | toString }}"
        JWT_SECRET: "{{ .jwt_secret | toString }}"
        ENCRYPTION_KEY: "{{ .encryption_key | toString }}"
        MFA_SECRET_KEY: "{{ .mfa_secret_key | toString }}"
  data:
  - secretKey: secret_key
    remoteRef:
      key: opssight/production/app
      property: secret_key
  - secretKey: jwt_secret
    remoteRef:
      key: opssight/production/app
      property: jwt_secret
  - secretKey: encryption_key
    remoteRef:
      key: opssight/production/app
      property: encryption_key
  - secretKey: mfa_secret_key
    remoteRef:
      key: opssight/production/app
      property: mfa_secret_key

---
# External Secret for Redis Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: opssight-redis-secrets
  namespace: opssight-production
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: redis-secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: opssight-redis-secrets
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: opssight
          app.kubernetes.io/component: redis-secrets
          environment: production
      data:
        REDIS_PASSWORD: "{{ .redis_password | toString }}"
        REDIS_URL: "redis://:{{ .redis_password | toString }}@{{ .redis_host | toString }}:6379/0"
  data:
  - secretKey: redis_password
    remoteRef:
      key: opssight/production/redis
      property: password
  - secretKey: redis_host
    remoteRef:
      key: opssight/production/redis
      property: host

---
# External Secret for Third-party Service Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: opssight-external-services
  namespace: opssight-production
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: external-services
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: opssight-external-services
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: opssight
          app.kubernetes.io/component: external-services
          environment: production
      data:
        SLACK_WEBHOOK_URL: "{{ .slack_webhook_url | toString }}"
        GITHUB_TOKEN: "{{ .github_token | toString }}"
        SMTP_PASSWORD: "{{ .smtp_password | toString }}"
        SMTP_USERNAME: "{{ .smtp_username | toString }}"
        OAUTH_CLIENT_SECRET: "{{ .oauth_client_secret | toString }}"
  data:
  - secretKey: slack_webhook_url
    remoteRef:
      key: opssight/production/external-services
      property: slack_webhook_url
  - secretKey: github_token
    remoteRef:
      key: opssight/production/external-services
      property: github_token
  - secretKey: smtp_password
    remoteRef:
      key: opssight/production/external-services
      property: smtp_password
  - secretKey: smtp_username
    remoteRef:
      key: opssight/production/external-services
      property: smtp_username
  - secretKey: oauth_client_secret
    remoteRef:
      key: opssight/production/external-services
      property: oauth_client_secret

---
# ClusterSecretStore for cluster-wide secrets (optional)
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: aws-secrets-manager-cluster
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: cluster-secret-store
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-west-2
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa
            namespace: opssight-production