---
# Cert-Manager ClusterIssuer for Let's Encrypt Production
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-production
  labels:
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: issuer
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: devops@opssight.dev
    privateKeySecretRef:
      name: letsencrypt-production
    solvers:
    - http01:
        ingress:
          class: alb
          podTemplate:
            spec:
              nodeSelector:
                kubernetes.io/os: linux
    - dns01:
        route53:
          region: us-east-1
          accessKeyID: AKIAIOSFODNN7EXAMPLE
          secretAccessKeySecretRef:
            name: route53-credentials
            key: secret-access-key
---
# Cert-Manager ClusterIssuer for Let's Encrypt Staging (for testing)
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-staging
  labels:
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: issuer
spec:
  acme:
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    email: devops@opssight.dev
    privateKeySecretRef:
      name: letsencrypt-staging
    solvers:
    - http01:
        ingress:
          class: alb
          podTemplate:
            spec:
              nodeSelector:
                kubernetes.io/os: linux
    - dns01:
        route53:
          region: us-east-1
          accessKeyID: AKIAIOSFODNN7EXAMPLE
          secretAccessKeySecretRef:
            name: route53-credentials
            key: secret-access-key
---
# Production SSL Certificate
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: opssight-production-tls
  namespace: opsight
  labels:
    app.kubernetes.io/name: opsight
    app.kubernetes.io/component: tls
spec:
  secretName: opssight-production-tls
  issuerRef:
    name: letsencrypt-production
    kind: ClusterIssuer
  dnsNames:
  - opssight.dev
  - www.opssight.dev
  - api.opssight.dev
  - app.opssight.dev
  - grafana.opssight.dev
  - prometheus.opssight.dev
  usages:
  - digital signature
  - key encipherment
  duration: 2160h # 90 days
  renewBefore: 360h # 15 days before expiry
---
# Staging SSL Certificate
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: opssight-staging-tls
  namespace: opsight
  labels:
    app.kubernetes.io/name: opsight
    app.kubernetes.io/component: tls
    app.kubernetes.io/env: staging
spec:
  secretName: opssight-staging-tls
  issuerRef:
    name: letsencrypt-staging
    kind: ClusterIssuer
  dnsNames:
  - staging.opssight.dev
  - api-staging.opssight.dev
  - app-staging.opssight.dev
  usages:
  - digital signature
  - key encipherment
  duration: 2160h # 90 days
  renewBefore: 360h # 15 days before expiry
---
# Route53 Credentials Secret (for DNS-01 challenge)
apiVersion: v1
kind: Secret
metadata:
  name: route53-credentials
  namespace: cert-manager
  labels:
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: credentials
type: Opaque
stringData:
  secret-access-key: "your-aws-secret-access-key-here"
---
# Certificate Monitoring ServiceMonitor
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: cert-manager-metrics
  namespace: cert-manager
  labels:
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: monitoring
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: cert-manager
  endpoints:
  - port: tcp-prometheus-servicemonitor
    interval: 60s
    path: /metrics
---
# Certificate Renewal CronJob
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cert-renewal-monitor
  namespace: cert-manager
  labels:
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: monitor
spec:
  schedule: "0 6 * * *"  # Daily at 6 AM
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: cert-monitor
            image: bitnami/kubectl:latest
            command:
            - /bin/sh
            - -c
            - |
              echo "Checking certificate renewals..."
              kubectl get certificates -A -o json | jq -r '
                .items[] | 
                select(.status.renewalTime != null) |
                select((.status.renewalTime | fromdateiso8601) < (now + 7*24*3600)) |
                "\(.metadata.namespace)/\(.metadata.name) expires soon: \(.status.renewalTime)"
              '
              
              # Check for failed certificates
              kubectl get certificates -A -o json | jq -r '
                .items[] |
                select(.status.conditions[]? | select(.type == "Ready" and .status == "False")) |
                "\(.metadata.namespace)/\(.metadata.name) is not ready: \(.status.conditions[] | select(.type == "Ready").message)"
              '
          restartPolicy: OnFailure
          serviceAccountName: cert-renewal-monitor
---
# ServiceAccount for Certificate Monitoring
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cert-renewal-monitor
  namespace: cert-manager
  labels:
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: monitor
---
# ClusterRole for Certificate Monitoring
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cert-renewal-monitor
  labels:
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: monitor
rules:
- apiGroups: ["cert-manager.io"]
  resources: ["certificates"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list"]
---
# ClusterRoleBinding for Certificate Monitoring
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cert-renewal-monitor
  labels:
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: monitor
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cert-renewal-monitor
subjects:
- kind: ServiceAccount
  name: cert-renewal-monitor
  namespace: cert-manager
---
# Network Policy for Cert-Manager
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: cert-manager-network-policy
  namespace: cert-manager
  labels:
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: security
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: cert-manager
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 9402  # Metrics port
  egress:
  - to: []  # Allow all outbound (needed for ACME challenges)
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 80
    - protocol: UDP
      port: 53
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: TCP
      port: 443  # Kubernetes API