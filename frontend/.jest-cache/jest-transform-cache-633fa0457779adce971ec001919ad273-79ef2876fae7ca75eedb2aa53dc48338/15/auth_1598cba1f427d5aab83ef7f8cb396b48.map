{"version":3,"names":["clearRefreshTiming","cov_1k1moclerp","f","s","needsRefresh","refreshToken","setNextRefresh","setupRefreshInterceptor","REFRESH_THRESHOLD","REFRESH_TIMING_KEY","refreshAt","localStorage","getItem","b","Date","now","parseInt","expiresIn","setItem","toString","removeItem","response","fetch","method","credentials","ok","error","json","Error","message","data","expires_in","code","status","axiosInstance","refreshPromise","interceptors","request","use","config","Promise","reject"],"sources":["/Users/pavan/Desktop/Devops-app-dev-cursor/frontend/src/utils/auth.ts"],"sourcesContent":["import { AuthResponse, AuthError } from '@/types/auth';\n\n/**\n * Time before token expiry to trigger refresh (5 minutes)\n */\nconst REFRESH_THRESHOLD = 5 * 60 * 1000;\n\n/**\n * Storage key for refresh timing\n */\nconst REFRESH_TIMING_KEY = 'auth_refresh_at';\n\n/**\n * Check if token needs refresh based on expiry time\n * @returns boolean indicating if refresh is needed\n */\nexport function needsRefresh(): boolean {\n  const refreshAt = localStorage.getItem(REFRESH_TIMING_KEY);\n  if (!refreshAt) return true;\n  \n  return Date.now() >= parseInt(refreshAt, 10);\n}\n\n/**\n * Calculate next refresh time based on token expiry\n * @param expiresIn - Token expiry time in seconds\n */\nexport function setNextRefresh(expiresIn: number): void {\n  // Calculate when to refresh (expiry minus threshold)\n  const refreshAt = Date.now() + (expiresIn * 1000) - REFRESH_THRESHOLD;\n  localStorage.setItem(REFRESH_TIMING_KEY, refreshAt.toString());\n}\n\n/**\n * Clear refresh timing from storage\n */\nexport function clearRefreshTiming(): void {\n  localStorage.removeItem(REFRESH_TIMING_KEY);\n}\n\n/**\n * Refresh the access token using the refresh token\n * @returns Promise with the new auth response\n * @throws AuthError if refresh fails\n */\nexport async function refreshToken(): Promise<AuthResponse> {\n  try {\n    const response = await fetch('/api/v1/auth/refresh', {\n      method: 'POST',\n      credentials: 'include', // Important for cookies\n    });\n\n    if (!response.ok) {\n      const error = await response.json();\n      throw new Error(error.message || 'Failed to refresh token');\n    }\n\n    const data: AuthResponse = await response.json();\n    \n    // Set next refresh time\n    setNextRefresh(data.expires_in);\n    \n    return data;\n  } catch (error) {\n    // Clear refresh timing on error\n    clearRefreshTiming();\n    \n    throw {\n      message: error instanceof Error ? error.message : 'Token refresh failed',\n      code: 'AUTH_REFRESH_ERROR',\n      status: 401,\n    } as AuthError;\n  }\n}\n\n/**\n * Create an axios interceptor for automatic token refresh\n * @param axiosInstance - Axios instance to add interceptor to\n */\nexport function setupRefreshInterceptor(axiosInstance: any): void {\n  let refreshPromise: Promise<AuthResponse> | null = null;\n\n  axiosInstance.interceptors.request.use(\n    async (config: any) => {\n      // Check if token needs refresh\n      if (needsRefresh()) {\n        try {\n          // Use existing refresh promise if one is in progress\n          refreshPromise = refreshPromise || refreshToken();\n          await refreshPromise;\n        } catch (error) {\n          // Clear the promise on error\n          refreshPromise = null;\n          throw error;\n        }\n      }\n      return config;\n    },\n    (error: any) => Promise.reject(error)\n  );\n} "],"mappings":"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","ignoreList":[]}