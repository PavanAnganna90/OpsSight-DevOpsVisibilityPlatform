{"version":3,"sources":["/Users/pavan/Desktop/Devops-app-dev-cursor/frontend/src/tests/contexts/TeamContext.test.tsx"],"sourcesContent":["import { renderHook, act } from '@testing-library/react';\nimport { ReactNode } from 'react';\nimport { TeamProvider, useTeam } from '../../contexts/TeamContext';\nimport { Team } from '../../types/team';\n\n// Mock localStorage\nconst mockLocalStorage = {\n  getItem: jest.fn(),\n  setItem: jest.fn(),\n  removeItem: jest.fn(),\n};\nObject.defineProperty(window, 'localStorage', {\n  value: mockLocalStorage,\n});\n\n// Mock the API calls\nconst mockGetUserTeams = jest.fn();\nconst mockGetTeamMembers = jest.fn();\njest.mock('../../services/teamApi', () => ({\n  teamApi: {\n    getUserTeams: mockGetUserTeams,\n    getTeamMembers: mockGetTeamMembers,\n  },\n}));\n\nconst mockTeams: Team[] = [\n  {\n    id: 1,\n    name: 'team-alpha',\n    display_name: 'Team Alpha',\n    description: 'Alpha development team',\n    slug: 'team-alpha',\n    settings: {\n      allow_external_invites: true,\n      require_admin_approval: false,\n      default_member_role: 'member' as any,\n      visibility: 'private',\n      notifications: { email: true, slack: false, webhook: false },\n    },\n    permissions: {\n      repository_access: true,\n      deployment_access: true,\n      monitoring_access: true,\n      cost_view_access: true,\n      settings_access: true,\n    },\n    is_active: true,\n    member_count: 5,\n    created_by_user_id: 1,\n    created_at: new Date().toISOString(),\n    updated_at: new Date().toISOString(),\n  },\n  {\n    id: 2, \n    name: 'team-beta',\n    display_name: 'Team Beta',\n    description: 'Beta testing team',\n    slug: 'team-beta',\n    settings: {\n      allow_external_invites: false,\n      require_admin_approval: true,\n      default_member_role: 'viewer' as any,\n      visibility: 'private',\n      notifications: { email: true, slack: true, webhook: false },\n    },\n    permissions: {\n      repository_access: true,\n      deployment_access: false,\n      monitoring_access: true,\n      cost_view_access: false,\n      settings_access: false,\n    },\n    is_active: true,\n    member_count: 3,\n    created_by_user_id: 2,\n    created_at: new Date().toISOString(),\n    updated_at: new Date().toISOString(),\n  },\n];\n\nconst wrapper = ({ children }: { children: ReactNode }) => (\n  <TeamProvider>{children}</TeamProvider>\n);\n\ndescribe('TeamContext', () => {\n  beforeEach(() => {\n    jest.clearAllMocks();\n    mockLocalStorage.getItem.mockReturnValue(null);\n  });\n\n  describe('Initial State', () => {\n    it('should have correct initial state', () => {\n      const { result } = renderHook(() => useTeam(), { wrapper });\n      \n      expect(result.current.state).toEqual({\n        currentTeam: null,\n        userTeams: [],\n        userRole: null,\n        isLoading: false,\n        error: null,\n        hasMultipleTeams: false,\n      });\n    });\n\n    it('should load teams on mount', async () => {\n      mockGetUserTeams.mockResolvedValueOnce(mockTeams);\n      mockGetTeamMembers.mockResolvedValueOnce([\n        { user_id: 1, role: 'ADMIN' }\n      ]);\n\n      const { result } = renderHook(() => useTeam(), { wrapper });\n\n      await act(async () => {\n        // Wait for the effect to complete\n        await new Promise(resolve => setTimeout(resolve, 100));\n      });\n\n      expect(mockGetUserTeams).toHaveBeenCalledTimes(1);\n      expect(result.current.state.userTeams).toEqual(mockTeams);\n      expect(result.current.state.currentTeam).toEqual(mockTeams[0]);\n      expect(result.current.state.hasMultipleTeams).toBe(true);\n      expect(result.current.state.error).toBeNull();\n    });\n  });\n\n  describe('Team Selection Persistence', () => {\n    it('should restore saved team from localStorage', async () => {\n      mockLocalStorage.getItem.mockReturnValue('2');\n      mockGetUserTeams.mockResolvedValueOnce(mockTeams);\n      mockGetTeamMembers.mockResolvedValueOnce([\n        { user_id: 2, role: 'MEMBER' }\n      ]);\n\n      const { result } = renderHook(() => useTeam(), { wrapper });\n\n      await act(async () => {\n        await new Promise(resolve => setTimeout(resolve, 100));\n      });\n\n      expect(result.current.state.currentTeam).toEqual(mockTeams[1]);\n      expect(mockLocalStorage.getItem).toHaveBeenCalledWith('opsight_selected_team_id');\n    });\n\n    it('should fallback to first team if saved team not found', async () => {\n      mockLocalStorage.getItem.mockReturnValue('999'); // Non-existent team\n      mockGetUserTeams.mockResolvedValueOnce(mockTeams);\n      mockGetTeamMembers.mockResolvedValueOnce([\n        { user_id: 1, role: 'ADMIN' }\n      ]);\n\n      const { result } = renderHook(() => useTeam(), { wrapper });\n\n      await act(async () => {\n        await new Promise(resolve => setTimeout(resolve, 100));\n      });\n\n      expect(result.current.state.currentTeam).toEqual(mockTeams[0]);\n    });\n  });\n\n  describe('Team Selection', () => {\n    it('should select teams correctly', async () => {\n      mockGetUserTeams.mockResolvedValueOnce(mockTeams);\n      mockGetTeamMembers\n        .mockResolvedValueOnce([{ user_id: 1, role: 'ADMIN' }])\n        .mockResolvedValueOnce([{ user_id: 2, role: 'MEMBER' }]);\n\n      const { result } = renderHook(() => useTeam(), { wrapper });\n\n      await act(async () => {\n        await new Promise(resolve => setTimeout(resolve, 100));\n      });\n\n      // Select team beta\n      await act(async () => {\n        await result.current.selectTeam(2);\n      });\n\n      expect(result.current.state.currentTeam).toEqual(mockTeams[1]);\n      expect(mockLocalStorage.setItem).toHaveBeenCalledWith('opsight_selected_team_id', '2');\n    });\n\n    it('should not select non-existent team', async () => {\n      mockGetUserTeams.mockResolvedValueOnce(mockTeams);\n      mockGetTeamMembers.mockResolvedValueOnce([\n        { user_id: 1, role: 'ADMIN' }\n      ]);\n\n      const { result } = renderHook(() => useTeam(), { wrapper });\n\n      await act(async () => {\n        await new Promise(resolve => setTimeout(resolve, 100));\n      });\n\n      const originalTeam = result.current.state.currentTeam;\n\n      // Try to select non-existent team\n      await act(async () => {\n        try {\n          await result.current.selectTeam(999);\n        } catch (error) {\n          // Expected to throw\n        }\n      });\n\n      expect(result.current.state.currentTeam).toEqual(originalTeam);\n    });\n  });\n\n  describe('Error Handling', () => {\n    it('should handle API errors correctly', async () => {\n      const errorMessage = 'Failed to fetch teams';\n      mockGetUserTeams.mockRejectedValueOnce(new Error(errorMessage));\n\n      const { result } = renderHook(() => useTeam(), { wrapper });\n\n      await act(async () => {\n        await new Promise(resolve => setTimeout(resolve, 100));\n      });\n\n      expect(result.current.state.userTeams).toEqual([]);\n      expect(result.current.state.currentTeam).toBeNull();\n      expect(result.current.state.isLoading).toBe(false);\n      expect(result.current.state.error).toBe(errorMessage);\n    });\n  });\n\n  describe('Team Utilities', () => {\n    it('should check team membership correctly', async () => {\n      mockGetUserTeams.mockResolvedValueOnce(mockTeams);\n      mockGetTeamMembers.mockResolvedValueOnce([\n        { user_id: 1, role: 'ADMIN' }\n      ]);\n\n      const { result } = renderHook(() => useTeam(), { wrapper });\n\n      await act(async () => {\n        await new Promise(resolve => setTimeout(resolve, 100));\n      });\n\n      expect(result.current.isTeamMember(1)).toBe(true);\n      expect(result.current.isTeamMember(2)).toBe(true);\n      expect(result.current.isTeamMember(999)).toBe(false);\n    });\n\n    it('should clear team selection', async () => {\n      mockGetUserTeams.mockResolvedValueOnce(mockTeams);\n      mockGetTeamMembers.mockResolvedValueOnce([\n        { user_id: 1, role: 'ADMIN' }\n      ]);\n\n      const { result } = renderHook(() => useTeam(), { wrapper });\n\n      await act(async () => {\n        await new Promise(resolve => setTimeout(resolve, 100));\n      });\n\n      // Clear team\n      act(() => {\n        result.current.clearTeam();\n      });\n\n      expect(result.current.state.currentTeam).toBeNull();\n      expect(result.current.state.userRole).toBeNull();\n    });\n  });\n}); "],"names":["jest","mock","teamApi","getUserTeams","mockGetUserTeams","getTeamMembers","mockGetTeamMembers","mockLocalStorage","getItem","fn","setItem","removeItem","Object","defineProperty","window","value","mockTeams","id","name","display_name","description","slug","settings","allow_external_invites","require_admin_approval","default_member_role","visibility","notifications","email","slack","webhook","permissions","repository_access","deployment_access","monitoring_access","cost_view_access","settings_access","is_active","member_count","created_by_user_id","created_at","Date","toISOString","updated_at","wrapper","children","TeamProvider","describe","beforeEach","clearAllMocks","mockReturnValue","it","result","renderHook","useTeam","expect","current","state","toEqual","currentTeam","userTeams","userRole","isLoading","error","hasMultipleTeams","mockResolvedValueOnce","user_id","role","act","Promise","resolve","setTimeout","toHaveBeenCalledTimes","toBe","toBeNull","toHaveBeenCalledWith","selectTeam","originalTeam","errorMessage","mockRejectedValueOnce","Error","isTeamMember","clearTeam"],"mappings":"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"}