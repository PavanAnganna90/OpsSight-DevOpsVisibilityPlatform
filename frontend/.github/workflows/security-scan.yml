# OpsSight Security Scanning Workflow
# Daily security scans and vulnerability monitoring

name: Security Scan

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'package*.json'
      - 'Dockerfile'
      - '.github/workflows/security-scan.yml'

env:
  NODE_VERSION: '20'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

permissions:
  contents: read
  security-events: write
  packages: read

jobs:
  # =============================================================================
  # Dependency Vulnerability Scan
  # =============================================================================
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Run npm audit
        run: npm audit --audit-level=moderate --json > npm-audit.json
        continue-on-error: true

      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=medium --json > snyk-results.json
        continue-on-error: true

      - name: Upload Snyk results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: snyk.sarif

  # =============================================================================
  # Container Image Security Scan
  # =============================================================================
  container-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image for scanning
        run: |
          docker build -t opssight:security-scan .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'opssight:security-scan'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Docker Scout
        uses: docker/scout-action@v1
        if: always()
        with:
          command: cves
          image: 'opssight:security-scan'
          sarif-file: 'scout-results.sarif'

      - name: Upload Docker Scout results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'scout-results.sarif'

  # =============================================================================
  # Code Security Analysis
  # =============================================================================
  code-security:
    name: Code Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          queries: security-and-quality

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      - name: Run Semgrep security scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
            p/javascript
            p/typescript
            p/react
            p/nextjs

  # =============================================================================
  # Secret Scanning
  # =============================================================================
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog secret scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

      - name: Run GitLeaks secret scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # =============================================================================
  # Security Compliance Check
  # =============================================================================
  compliance-check:
    name: Security Compliance Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Run security tests
        run: npm run test:security

      - name: Check security headers
        run: npm run test:security-headers

      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'OpsSight'
          path: '.'
          format: 'ALL'
          args: >
            --enableRetired
            --enableExperimental
            --failOnCVSS 7

      - name: Upload OWASP Dependency Check results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: reports/dependency-check-report.sarif

  # =============================================================================
  # Notification & Reporting
  # =============================================================================
  notify:
    name: Security Scan Notification
    runs-on: ubuntu-latest
    needs: [dependency-scan, container-scan, code-security, secret-scan, compliance-check]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Check scan results
        id: check
        run: |
          if [[ "${{ needs.dependency-scan.result }}" == "failure" ]] || \
             [[ "${{ needs.container-scan.result }}" == "failure" ]] || \
             [[ "${{ needs.code-security.result }}" == "failure" ]] || \
             [[ "${{ needs.secret-scan.result }}" == "failure" ]] || \
             [[ "${{ needs.compliance-check.result }}" == "failure" ]]; then
            echo "status=failure" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
          fi

      - name: Notify security team on failure
        if: steps.check.outputs.status == 'failure'
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#security-alerts'
          text: 'ðŸš¨ OpsSight security scan failed! Please review the findings.'
          webhook_url: ${{ secrets.SECURITY_SLACK_WEBHOOK }}

      - name: Create security issue on failure
        if: steps.check.outputs.status == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Security Scan Failure - ${new Date().toDateString()}`,
              body: `ðŸš¨ **Security Scan Alert**\n\nOne or more security scans have failed. Please review the findings in the Security tab.\n\n**Failed Scans:**\n- Dependency Scan: ${{ needs.dependency-scan.result }}\n- Container Scan: ${{ needs.container-scan.result }}\n- Code Security: ${{ needs.code-security.result }}\n- Secret Scan: ${{ needs.secret-scan.result }}\n- Compliance Check: ${{ needs.compliance-check.result }}\n\n**Action Required:** Review and remediate security findings.`,
              labels: ['security', 'bug', 'high-priority']
            });

      - name: Weekly security report
        if: github.event.schedule == '0 2 * * 1' # Monday
        uses: actions/github-script@v7
        with:
          script: |
            // Generate weekly security report
            const report = `## Weekly Security Report - ${new Date().toDateString()}\n\nâœ… All security scans completed successfully.\n\n**Scans Performed:**\n- Dependency vulnerability scan\n- Container security scan\n- Code security analysis\n- Secret scanning\n- Compliance check\n\n**Next Steps:**\n- Continue monitoring for new vulnerabilities\n- Update dependencies as needed\n- Review security policies`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Weekly Security Report - ${new Date().toDateString()}`,
              body: report,
              labels: ['security', 'report']
            }); 